{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"location": {
			"type": "string",
			"defaultValue": "eastus",
			"metadata": {
				"description": "The Azure region where all resources will be deployed."
			},
			"allowedValues": [
				"eastus",
				"westus2",
				"westcentralus",
				"northeurope",
				"westeurope",
				"southeastasia",
				"australiaeast"
			]
		}
	},
	"variables": {
		"nameSuffix": "[uniqueString(resourceGroup().id)]",
		"machineLearningServicesWorkspaceName": "[concat('Cosmos-DB-IoT-ML-', variables('nameSuffix'))]",
		"machineLearningServicesStorageAccountName": "[concat('mlstore', variables('nameSuffix'))]",
        "keyVaultName": "[concat('iot-vault-', variables('nameSuffix'))]",
        "appInsightsName": "[concat('Cosmos-DB-IoT-Insights-', variables('nameSuffix'))]",
		"apiVersionMachineLearning": "2020-04-01",
		"apiVersionStorage": "2019-06-01"
	},
	"resources": [
		{
			"type": "Microsoft.Storage/storageAccounts",
			"apiVersion": "[variables('apiVersionStorage')]",
			"name": "[variables('machineLearningServicesStorageAccountName')]",
			"location": "[parameters('location')]",
			"sku": {
				"name": "Standard_LRS",
				"tier": "Standard"
			},
			"kind": "Storage",
			"properties": {
				"networkAcls": {
					"bypass": "AzureServices",
					"virtualNetworkRules": [
					],
					"ipRules": [
					],
					"defaultAction": "Allow"
				},
				"supportsHttpsTrafficOnly": false,
				"encryption": {
					"services": {
						"file": {
							"enabled": true
						},
						"blob": {
							"enabled": true
						}
					},
					"keySource": "Microsoft.Storage"
				}
			}
		},
		{
			"type": "Microsoft.MachineLearningServices/workspaces",
			"apiVersion": "[variables('apiVersionMachineLearning')]",
			"name": "[variables('machineLearningServicesWorkspaceName')]",
			"location": "[parameters('location')]",
			"dependsOn": [
				"[resourceId('Microsoft.Storage/storageAccounts', variables('machineLearningServicesStorageAccountName'))]"
			],
			"identity": {
				"type": "SystemAssigned"
			},
			"properties": {
				"friendlyName": "[variables('machineLearningServicesWorkspaceName')]",
				"storageAccount": "[resourceId('Microsoft.Storage/storageAccounts/', variables('machineLearningServicesStorageAccountName'))]",
                "keyVault": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
                "applicationInsights": "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
			}
		}
    ],
    "outputs": {
	}
}